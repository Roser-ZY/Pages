---
title: "CPU 缓存一致性"
author: "Roser"
date: 2025-05-08
image: "images/content/OS.png"
draft: false
tags:
  - OS
  - Concurrency
  - Review
  - Draft
sr-due: 2025-06-20
sr-interval: 56
sr-ease: 250
---
CPU 的缓存数据更新策略主要有**写直达**和**写回**。

写直达是指写入缓存同时更新内存。写回则是当缓存的 Cache Line 被替换时才更新内存。

写直达的效率较低，目前比较主流的是写回。
### 缓存一致性问题

但是写回在现在多核 CPU 的架构下存在缓存一致性问题。L1/L2 Cahce 是每个核独占的，L3 Cache 是多核共享的，如果某个核修改了缓存内的某个数据，没有及时更新到内存，则其他核读取相同数据就会导致错误（因为读取的还是旧数据）。

除了数据更新问题外，如果多个核都修改了数据，则在写回时，还存在数据操作顺序的问题。即需要多个核的修改在其他核看来执行顺序是一致的，避免出现数据错误。

在硬件层面，通过**写传播**和**事务串行化**来解决上面这两个问题。
### 解决方案

写传播是指 Cache 更新时，同步数据到其他核心的 Cache 中。写传播最常见的实现方式是**总线嗅探**。CPU 会每时每刻监听总线活动，当执行写传播时，会将事件广播到其他核心。

但是如果每次更新都进行广播，会大大增加总线负载。目前通常采用 MESI 协议解决写传播的效率问题和事务串行化。

> MESI 能减少广播的频率。

![](images/MESI状态转换表.webp)