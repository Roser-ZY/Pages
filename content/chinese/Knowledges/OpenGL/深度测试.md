---
title: "深度测试"
author: "Roser"
date: 2025-04-14
image: "images/content/OpenGL.png"
draft: false
tags:
  - OpenGL
  - Draft
  - Review
sr-due: 2025-05-13
sr-interval: 29
sr-ease: 254
---
根据生活经验，近处的物体会挡住后面的东西，我们可以通过深度测试来实现这样的效果。

深度测试的原理是：比较当前片段的深度值是否比深度缓冲中预设的值小（意味着片元距离观察点更近），如果是则更新深度缓冲和颜色缓冲；否则丢弃片段，不更新缓冲区的值。

片段深度值是在进行[透视除法](坐标系统.md)时计算得到的，然后在[光栅化](光栅化.md)阶段记录到片段信息上。在[片段着色器](Shader/片段着色器.md)能够访问深度值（即 `gl_FragCoord.z`。

深度测试时，比较的是该片段的深度值和深度缓冲中在当前片段已有的值（前一次绘制的物体写入，或者是初始化数据）。

> 深度缓冲初始值会根据不同的测试方法有不同，如果是 GL_LESS 则默认为 1.0（即最大值），如果是 GL_GREATER 则默认是 0.0（即最小值）。

可以看出绘制顺序对深度测试和深度缓冲的更新是有影响的，这也是为什么[混合](Advanced/启用深度测试时混合透明物体的绘制顺序对结果的影响.md)时要考虑绘制顺序，另外绘制顺序也会影响深度测试效率。

片段着色器也可以通过修改 `gl_FragDepth` 来修改片段深度值，从而影响最终深度测试结果和深度缓冲的数据。
### 深度值

在透视投影中，深度值不是线性的。这是因为透视投影中，远处的物体更小，他们之间的深度值差异也会更小，精度要求更小；而近处的物体更大，深度值差异更大，且精度要求更高。

> 其实就是近大远小的原理。
> 想象一个球体，在近处的时候会更大，它的前面和背面在观察者看来差距是更大的。而在远处时很小，虽然现实中球体还是一样大的，但是在计算机中是用二维模拟三维，因此计算时球体的深度值是要更小的，精度要求更低。

正交投影中，深度值是线性的。
### 深度冲突

两个面可能本身存在比较小的深度差值，但由于精度问题，这两个面在深度测试是会出现冲突，即有一部分深度测试通过而另一部分深度测试未通过，从而出现两个面重叠出现的问题。该问题称为 Z-Fighting。

可通过添加一点深度偏移（Depth Bias）修改深度值来避免该问题。