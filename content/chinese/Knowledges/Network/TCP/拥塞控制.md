---
title: "拥塞控制"
author: "Roser"
date: 2025-05-09
image: "images/content/Network.png"
draft: false
tags:
  - Network
  - TCP
  - Review
sr-due: 2025-08-02
sr-interval: 114
sr-ease: 232
---
网络是共享的，会存在多个端所有的数据，拥塞控制就是控制网络中整体的数据流量。

与[流量控制](../流量控制)不同，拥塞控制是对整个网络和发送端来说的。通过拥塞控制，可以控制当前发送端向网络中传播的数据量，从而确保网络中整体的数据量保持在一个合理的范围。

拥塞窗口（cwnd）是发送方维护的一个状态变量，会根据网络的拥塞成都动态变化。它和滑动窗口是约等于的关系，发送窗口大小的计算公式为 $swnd = min(cwnd, rwnd)$。

只要发送方触发了超时重传，就会认为网络出现了拥塞，此时会减少拥塞窗口。如果一直没有发现拥塞，则会增大拥塞窗口。

拥塞控制主要由以下四个算法来实现。
# 慢启动

建立 TCP 连接后，会有一个慢启动的过程，即一点点提高发送数据包的数量。

发送方每收到一个 ACK，拥塞窗口的大小就会加一。

虽然看起来是线性增加，但实际上是**指数增加**。因为拥塞窗口初始增加到 2 时，意味着下次正常接收到的 ACK 为 2，则下次拥塞窗口会增加到 4，以此类推。

可见，虽然称为慢启动，但是实际是指数增加，其增长速度是很快的，如果任由其增加，则很快会导致网络拥堵。因此，TCP 提供了一个慢启动阈值（sstresh）：

$$
\begin{align}
& cwnd < ssthresh 时，慢启动。\\
& cwnd >= ssthresh 时，拥塞避免。
\end{align}
$$
# 拥塞避免

拥塞避免是**线性增长**的，当 cwnd 到达 ssthresh 时，就会进入拥塞避免算法。一般来说 sshresh 为 65535 字节。

进入拥塞避免算法后，每收到一个 ACK，cwnd 增加 1/cwnd。

> 假设 sshthresh 为 8，当进入拥塞避免时，发送了 8 个报文，并收到 8 个 ACK，每个确认增加 1/8，则 8 个 ACK 收到后，cwnd 一共增加 1，于是下次可发送 9 个报文，变成了线性增长。
# 拥塞发生

当发生重传时，意味着网络出现阻塞。根据重传方式的不同会执行不同的拥塞发生算法。

当发生超时重传时，ssthresh 变为 cwnd/2，cwnd 变为初始值。意味着拥塞避免阶段将会比重传之前更快进入，并且发送数据量一夜回到解放前。

当发生[快速重传](../快速重传)时，拥塞发生算法会使用快速恢复的方式。

> 可以认为拥塞发生只是发生超时重传时的拥塞控制算法，而快速恢复是发生快速重传时的拥塞控制算法。
# 快速恢复

快速恢复算法和快速重传一般同时使用。

快速恢复算法认为，既然能连续收到三个 ACK，说明网络拥塞情况并没有很严重，没必要使用拥塞发生算法如此激烈的减少发送量。

发生快速重传时，快速恢复算法会将 cwnd 变为 cwnd/2，而 ssthresh 变为 cwnd，然后进入快速恢复算法流程。

cwnd 设置为 ssthresh + 3（意味着接收了三个 ACK），然后重传丢失的数据包，如果又收到了重复的 ACK（即与之前的三个相同），则 cwnd 增加 1，这样增加直到收到新的 ACK（与之前请求重传的 ACK 不同）。

收到新的 ACK 时，cwnd 重置为当前 ssthresh 值，快速恢复算法结束，重新进入拥塞避免算法。

> 可见快速恢复是针对快速重传丢失报文设计的，并在一定程度上减少网络数据量。重置 cwnd 为 ssthresh 是因为丢失报文已经被成功接收，不需要再快速恢复了。